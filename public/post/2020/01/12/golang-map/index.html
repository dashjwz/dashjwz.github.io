<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>golangä¸‹mapçš„æ€§èƒ½åˆ†æ | Dashjay&#39;s</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/theme-override.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body);
        });
    </script>

<header>

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="/">/home/dashjay&#39;s</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/">~/home</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/categories/">~/categories</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/tags/">~/tags</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/index.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">golangä¸‹mapçš„æ€§èƒ½åˆ†æ</span></h1>
<h2 class="author">dashjay</h2>
<h2 class="date">2020/01/12</h2>
<p class="terms">
  
  
  
  
  
</p>
</div>



<main>
<h2 id="golang-ä¸­-map-æ€§èƒ½ä¼˜åŒ–ä½é˜¶">golang ä¸­ map æ€§èƒ½ä¼˜åŒ–[ä½é˜¶]</h2>
<h3 id="ç®€å•ä»‹ç»">ç®€å•ä»‹ç»</h3>
<p>golang ä¸­çš„ build-in çš„ map è¿™ä¸ª map æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªå®¶ä¼™ã€‚
ä¸ºäº†æµ‹è¯•å¤šä¸ª map çš„æ€§èƒ½æˆ‘å†™äº†ä¸ªæ¥å£ Map</p>
<pre><code>type Map interface {
	Set(key interface{}, val interface{})
	Get(key interface{}) (interface{}, bool)
	Del(key interface{})
}
</code></pre><p>ç„¶åè¿™æ˜¯å°è£…çš„æ™®é€šçš„ map</p>
<pre><code>type OriginMap struct {
	m map[interface{}]interface{}
}

func NewOriginMap() *OriginMap {
	return &amp;OriginMap{m: make(map[interface{}]interface{})}
}

func (o *OriginMap) Get(key interface{}) (interface{}, bool) {
	v, ok := o.m[key]
	return v, ok
}
func (o *OriginMap) Set(key interface{}, value interface{}) {
	o.m[key] = value
}

func (o *OriginMap) Del(key interface{}) {
	delete(o.m, key)
}
</code></pre><p>åˆ«çœ‹ä¸€å †ä»£ç ï¼Œå…¶å®å°±æ˜¯ get å’Œ set æ“ä½œã€‚åœ¨è¿™é‡Œæˆ‘ä»¬è¦ä½¿ç”¨ golang è‡ªå¸¦çš„ test å·¥å…·</p>
<pre><code>func TestOriginMaps(t *testing.T) {
	hm := NewOriginMap()
	wg := sync.WaitGroup{}
	for i := 0; i &lt; Writer; i++ {
		wg.Add(1)
		go func(wg *sync.WaitGroup) {
			for k := 0; k &lt; 100; k++ {
				hm.Set(strconv.Itoa(k), k*k)
				val, _ := hm.Get(strconv.Itoa(k))
				t.Logf(&quot;Get %d = %d&quot;, k, val)
			}
			wg.Done()
		}(&amp;wg)
	}
	wg.Wait()
}
</code></pre><p>è¿™å…¶ä¸­æœ‰ä¸ªå˜é‡ Writer å°±æ˜¯å†™è€…çš„æ•°é‡ï¼Œå¦‚æœåªæœ‰ 1 çš„æ—¶å€™ç¨‹åºèƒ½å®‰å…¨è¿è¡Œé€€å‡º</p>
<pre><code>1264 Â± : go test map_test/map_performance_test.go -v           â [3h1m] âœ¹ âœš âœ­
=== RUN   TestOriginMaps
--- PASS: TestOriginMaps (0.00s)
    map_performance_test.go:71: Get 0 = 0
    map_performance_test.go:71: Get 1 = 1
......
    map_performance_test.go:71: Get 99 = 9801
PASS
ok      command-line-arguments  0.339s
</code></pre><p>ä½†æ˜¯ä¸€æ—¦æˆ‘ä»¬æŠŠ Writer æ•°é‡æ”¹ä¸º 2</p>
<pre><code>1264 Â± : go test map_test/map_performance_test.go -v             [3h2m] âœ¹ âœš âœ­
=== RUN   TestOriginMaps
fatal error: concurrent map writes

goroutine 21 [running]:
</code></pre><p>ç«‹é©¬å°±çˆ†ç‚¸äº†ã€‚é‚£ä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿgolang è‡ªå·±å®˜æ–¹å¿ƒç†æ²¡æ•°ä¹ˆï¼Ÿ</p>
<p>å½“ç„¶æœ‰æ•° golang å¼€å‘è€…å…¶ä¸­ä¹‹ä¸€å¯æ˜¯æ‹¿å›¾çµå¥–çš„ã€‚ä½ å¯ä»¥ç‚¹å‡»<a href="https://stackoverflow.com/questions/11063473/map-with-concurrent-access" title="stackoverflowè¿™é‡Œ">stackoverflow ä¸Šçš„è®¨è®º</a>å’Œ<a href="https://github.com/golang/go/issues/21035" title="github ä¸Šçš„è®¨è®º">github è¿™é‡Œ</a>å»æŸ¥çœ‹ç›¸å…³çš„ issue</p>
<h3 id="syncmap">Sync.Map</h3>
<p>è¿™æ˜¯æŸå¤§ä½¬æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¯•è¯•</p>
<pre><code>type SyncMap struct {
	m sync.Map
}

func NewSyncMap() *SyncMap {
	return &amp;SyncMap{}
}

func (o *SyncMap) Get(key interface{}) (interface{}, bool) {
	v, ok := o.m.Load(key)
	return v, ok
}
func (o *SyncMap) Set(key interface{}, value interface{}) {
	o.m.Store(key, value)
}

func (o *SyncMap) Del(key interface{}) {
	o.m.Delete(key)
}
</code></pre><p>æˆ‘ç®€å•å°è£…äº†ä¸€ä¸‹ï¼Œæµ‹è¯•ä¸ªæ€§èƒ½æ²¡å•¥é—®é¢˜ã€‚</p>
<p>ç°åœ¨æŠŠ Write å¢åŠ ä¹Ÿæ²¡é—®é¢˜äº†ï¼Œå¯æ˜¯çœŸçš„æ²¡é—®é¢˜ä¹ˆï¼Ÿ</p>
<p>æˆ‘ä»¬ç°åœ¨å°æ”¹ä¸€ä¸‹ç¬¬ä¸€ç§ map åŠ äº†ä¸ª RW é”ï¼Œç„¶åå’Œè¿™ç§ map åšä¸€ä¸‹æ¯”è¾ƒçœ‹çœ‹ï¼Ÿ</p>
<pre><code>type OriginWithRWLock struct {
	m map[interface{}]interface{}
	l sync.RWMutex
}

func NewOriginWithRWLock() *OriginWithRWLock {
	return &amp;OriginWithRWLock{
		m: make(map[interface{}]interface{}),
		l: sync.RWMutex{},
	}
}

func (o *OriginWithRWLock) Get(key interface{}) (interface{}, bool) {
	o.l.RLock()
	v, ok := o.m[key]
	o.l.RUnlock()
	return v, ok
}
func (o *OriginWithRWLock) Set(key interface{}, value interface{}) {
	o.l.Lock()
	o.m[key] = value
	o.l.Unlock()
}

func (o *OriginWithRWLock) Del(key interface{}) {
	o.l.Lock()
	delete(o.m, key)
	o.l.Unlock()
}
</code></pre><p>ç„¶åæˆ‘ä»¬è¿™æ¬¡ç”¨ Test é‡Œçš„ Benchmark è¯•è¯•çœ‹</p>
<pre><code>func BenchmarkMaps(b *testing.B) {

	b.Logf(&quot;Writer: %d,Reader: %d&quot;, Writer, Readers)
	b.Run(&quot;map with SyncLock&quot;, func(b *testing.B) {
		hm := NewSyncMap()
		benchmarkMap(b, hm)
	})

	b.Run(&quot;map with RWLock&quot;, func(b *testing.B) {
		hm := NewOriginWithRWLock()
		benchmarkMap(b, hm)
	})
}

func benchmarkMap(b *testing.B, hm Map) {
	for i := 0; i &lt; b.N; i++ {
		var wg sync.WaitGroup
		for j := 0; j &lt; Writer; j++ {
			wg.Add(1)
			go func() {
				for k := 0; k &lt; 100; k++ {
					hm.Set(strconv.Itoa(k), k*k)
					hm.Set(strconv.Itoa(k), k*k)
					hm.Del(strconv.Itoa(k))
				}
				wg.Done()
			}()
		}
		for j := 0; j &lt; Readers; j++ {
			wg.Add(1)
			go func() {
				for k := 0; k &lt; 100; k++ {
					hm.Get(strconv.Itoa(k))
				}
				wg.Done()
			}()
		}
	}
}
</code></pre><p>é¦–å…ˆæ˜¯ BenchMark çš„å‡½æ•°å½“ä½¿ç”¨</p>
<p><code>go test .... -bench=.</code></p>
<p>çš„æ—¶å€™ä¼šè¢«è°ƒç”¨ï¼Œç„¶åæ¥æµ‹è¯•ä¸¤ç§ Map æ€§èƒ½ï¼Œä¸Šé¢é‚£ä¸ªæ˜¯æµ‹è¯•æ€§èƒ½çš„å‡½æ•°ï¼Œåˆ†åˆ«å¯¹ä¸¤ä¸ªå‡½æ•°çš„è¿›è¡Œæµ‹è¯•~~æ‹­ç›®ä»¥å¾…</p>
<blockquote>
<p>å½“ä¸¤è€…éƒ½æ˜¯ 100 çš„æ—¶å€™</p>
</blockquote>
<pre><code>1266 Â± : go test map_test/map_performance_test.go -bench=. -v                                                                                       [3h29m] âœ¹ âœš âœ­
goos: darwin
goarch: amd64
BenchmarkMaps/map_with_SyncLock-8                   1459            749699 ns/op
BenchmarkMaps/map_with_RWLock-8                     1688           1405360 ns/op
--- BENCH: BenchmarkMaps
    map_performance_test.go:92: Writer: 100,Reader: 100
PASS
ok      command-line-arguments  4.674s

</code></pre><p>ç„¶åæˆ‘æµ‹è¯•äº†ï¼Œå„ç§æƒ…å†µä¸‹çš„æ¯”è¾ƒç”»äº†ä¸ªè¡¨æ ¼ å•ä½æ˜¯ ns/op ,æ¯æ¬¡æ“ä½œéœ€è¦çš„ç§’æ•°</p>
<table>
<thead>
<tr>
<th>R/W</th>
<th>map_with_SyncLock</th>
<th>map_with_RWLock</th>
</tr>
</thead>
<tbody>
<tr>
<td>100/100</td>
<td>749699</td>
<td>1405360</td>
</tr>
<tr>
<td>10/100</td>
<td>2053942</td>
<td>333406</td>
</tr>
<tr>
<td>100/10</td>
<td>432235</td>
<td>1076423</td>
</tr>
<tr>
<td>100/200</td>
<td>1474482</td>
<td>1920310</td>
</tr>
<tr>
<td>200/100</td>
<td>1135713</td>
<td>2372780</td>
</tr>
</tbody>
</table>
<p>é‚£ä¹ˆä»è¿™ä¸ªè¡¨é‡Œå¯ä»¥çœ‹å‡ºï¼ŒSyncMap çš„æ•´ä½“æ€§èƒ½æ˜¯ä¼˜äº mapWithRWLock çš„æˆ‘æ¥åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆ</p>
<p>ä»å¤è‡³ä»Šï¼Œäººä»¬ä¸€ç›´åœ¨æ—¶é—´å’Œç©ºé—´ä¸Šåšæ–—äº‰ï¼Œè¿™æ¬¡ä¹Ÿä¸ä¾‹å¤–ï¼Œä¸¤ç§é”çš„å®ç°åŸç†ä¸ä¸€æ ·ã€‚</p>
<p><img src="https://imgkr.cn-bj.ufileos.com/8ce8ae6e-8cee-421c-8d54-0057d287e448.png" alt=""></p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨æ™®é€š Map å¸¦ RWMutex ä¼šå°†æ•´å—å†…å­˜é”ä½ï¼Œç„¶åå…¶ä»–è¯·æ±‚å°±è¦ç­‰å¾…ã€‚
SyncMap æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<p><img src="https://imgkr.cn-bj.ufileos.com/9fd62de8-9760-47d5-a525-eb043b409a0c.png" alt=""></p>
<p>å®ƒåˆ†ä¸ºä¸¤å—å†…å­˜ï¼ˆå­˜çš„éƒ½æ˜¯æŒ‡é’ˆï¼‰ï¼Œä¸€å—åªè¯»åŒºåŸŸï¼Œä¸€å— Dirty åŒºåŸŸæ”¯æŒè¯»å†™ã€‚</p>
<p>ä¸¤è¾¹çš„æŒ‡é’ˆæŒ‡å‘åŸæ•°æ®ï¼Œå½“éœ€è¦ Get çš„æ—¶å€™ä»–ä¼šæ‰§è¡Œ<code>Load</code>æ“ä½œä» Read ä¸­å»è·å–æŒ‡é’ˆæŒ‡å‘çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼ˆ<code>miss</code>ï¼‰å‘ç”Ÿäº†ï¼Œå°±è½¬è€Œä¼šå» dirty ä¸­è·å¾—æ•°æ®å¹¶ä¸”å­˜å…¥ Read ä¸­ã€‚</p>
<p>å½“<code>miss</code>è¶…è¿‡ä¸€å®šæ•°é‡çš„æ—¶å€™ï¼Œä»–å°±ä¼šç”¨åŸå­æ“ä½œæŠŠ dirty çš„æ•°æ® Promote åˆ° ReadOnly ä¸­ã€‚</p>
<p>å› æ­¤ Sync è¿™ç§æœºåˆ¶ï¼Œå¾€å¾€åªé€‚ç”¨äº Key-Value ç›¸å¯¹ç¨³å®šçš„ä¸šåŠ¡æƒ…å†µï¼Œè¯»å¤šå†™å°‘çš„ä¸šåŠ¡ã€‚</p>
<blockquote>
<p>æ‰‹ç—’æƒ³å†™ä¸ªå†…å­˜çš„çœ‹çœ‹åˆ°åº•å¤šèŠ±å¤šå°‘å†…å­˜
go tool pprof æ˜¯ä¸€ä¸ªå·¥å…·å¯ä»¥æŸ¥çœ‹ä»£ç æµ‹è¯„äº§ç”Ÿçš„å†…å­˜æ—¥å¿—</p>
</blockquote>
<pre><code>go test map_test/map_performance_test.go -bench=. -memprofile=mem.prof
go tool pprof map.test mem.prof
(pprof)top
...
      flat  flat%   sum%        cum   cum%
    1.54GB 57.95% 57.95%     1.57GB 59.14%  command-line-arguments_test.benchmarkMap.func2
    0.43GB 16.22% 74.17%     0.69GB 25.94%  command-line-arguments_test.benchmarkMap.func1

</code></pre><p>ä¸ç”¨è¯´äº†è¿™çœ‹èµ·æ¥ä¸‰å€çš„å†…å­˜æ¶ˆè€—ï¼Œæœç„¶è¶Šå¿«å†…å­˜è¶Šå¤§ã€‚é‚£ä¹ˆï¼Ÿæœ¬æ¬¡æµ‹è¯„åˆ°æ­¤ç»“æŸï¼Ÿ</p>
<p>ï¼ï¼ï¼ å¹¶æ²¡æœ‰ï¼ï¼ï¼
è¿˜æœ‰ä¸€ä¸ªå¤§ä½¬å†™äº†ä¸ª concurrent-map ç”šå¼ï¼Œæˆ‘ä»¬æ¥è§‚æ‘©ä¸€æ³¢ã€‚<a href="https://github.com/orcaman/concurrent-map" title="concurrent-map">concurrent-map</a></p>
<p>ç«‹é©¬å°è£…ä¸€æ³¢</p>
<pre><code>type ConCurrentMap struct {
	m cmap.ConcurrentMap
}

func NewConCurrentMap() *ConCurrentMap {
	conMap := cmap.New()
	return &amp;ConCurrentMap{m: conMap}
}

type OriginMap struct {
	m map[interface{}]interface{}
}

func (c *ConCurrentMap) Get(key interface{}) (interface{}, bool) {
	v, ok := c.m.Get(key.(string))
	return v, ok
}
func (c *ConCurrentMap) Set(key interface{}, value interface{}) {
	c.m.Set(key.(string), value)
}

func (c *ConCurrentMap) Del(key interface{}) {
	c.m.Remove(key.(string))
}
</code></pre><p>è¿«ä¸åŠå¾…å¼€å§‹æµ‹è¯•ï¼Œå½“ Write=100ï¼ŒReader=100 çš„æ—¶å€™</p>
<pre><code>1271 Â± : go test map_test/map_performance_test.go -bench=. -v                                                                                       [4h11m] âœ¹ âœš âœ­
goos: darwin
goarch: amd64
BenchmarkMaps/map_with_SyncLock-8                   1374            760728 ns/op
BenchmarkMaps/map_with_RWLock-8                     1671           1556679 ns/op
BenchmarkMaps/concurrentMap-8                       2667           1060736 ns/op
--- BENCH: BenchmarkMaps
    map_performance_test.go:114: Writer: 100,Reader: 100
</code></pre><p>é‚£ä¹ˆæˆ‘åŒæ ·åšä¸ªè¡¨æ ¼å§ï¼ŒæŠŠè¯»å†™çš„å‡ ç§æƒ…å†µéƒ½åˆ—å‡ºæ¥</p>
<table>
<thead>
<tr>
<th>R/W</th>
<th>map_with_SyncLock</th>
<th>map_with_RWLock</th>
<th>concurrentMap</th>
</tr>
</thead>
<tbody>
<tr>
<td>100/100</td>
<td>760728</td>
<td>1556679</td>
<td>1060736</td>
</tr>
<tr>
<td>10/100</td>
<td>1690986</td>
<td>338078</td>
<td>457065</td>
</tr>
<tr>
<td>100/10</td>
<td>443063</td>
<td>1026160</td>
<td>544635</td>
</tr>
</tbody>
</table>
<p>æœ€åè¯´ä¸€ä¸‹è¿™ä¸ªå¹¶å‘è¯»mapæ˜¯æ€ä¹ˆæçš„</p>
<p><img src="https://imgkr.cn-bj.ufileos.com/84240d5a-21a9-4df7-8cf6-97fd06dc2b11.png" alt=""></p>
<p>å·¦è¾¹æ˜¯æ™®é€šçš„mapï¼Œå½“æœ‰è¯»å†™çš„æ—¶å€™é”ä¸Šäº†ï¼Œå…¶ä»–çº¿ç¨‹å°±æ— æ³•è¯»å†™äº†ã€‚å³è¾¹çš„äº‹<code>concurrentMap</code>ï¼Œä»–åˆ©ç”¨äº†ä¸€ç§<code>partition</code>çš„æ€æƒ³ï¼ŒæŠŠ<code>Map</code>çš„å†…å­˜<code>SHARD</code>ï¼ˆåˆ†å‰²ï¼‰æˆNä»½ï¼Œç„¶åç”¨ä¸åŒçš„ğŸ”é”ä¸Šé”ï¼Œé‚£ä¹ˆé™ä½äº†éœ€è¦èµ„æºè¢«é”çš„æ¦‚ç‡ã€‚</p>
<p>æˆ‘ä»¬åœ¨æ—¥å¸¸ä¸­ç¼–ç¨‹çš„æ—¶å€™å®¹æ˜“é™·å…¥ä¸€ç§è¯¯åŒºï¼Œå°±æ˜¯è¿™é”ï¼Œé‚£é”ï¼Œå…¨é”ä¸Šï¼Œé¢è¯•ä¹Ÿåœ¨é—®å„ç§é”ï¼Œä½†æ˜¯åœ¨çœŸå®QPSæ¯”ä»·é«˜çš„ä¸šåŠ¡ä¸­ï¼Œé”æ˜¯ä¸€ç§å¾ˆå¯æ€•çš„ä¸œè¥¿ï¼Œå¦‚æœèƒ½åœ¨ç¼–ç¨‹çš„æ—¶å€™å¥½å¥½æƒ³æƒ³å†™å‡º<code>LockFree</code>çš„ç¨‹åºæ˜¯æœ€å¥½çš„å•Šã€‚</p>
<p>æˆ‘æ˜¯åŒ—äº¬æŸ211çš„æ··å­ï¼Œä»19å¹´10æœˆå¼€å§‹å†™ä¸¤è¡Œgolangåˆ°ç°åœ¨ä¸çŸ¥ä¸è§‰å·²ç»è¿‡å»äº†2ä¸ªæœˆï¼Œä¸Šæ‰‹å°±å¼€å§‹æ‹‰æ¡†æ¶å†™ä»£ç çš„æˆ‘å·²ç»è¿›åŒ–åˆ°å¼€å§‹åˆ†ææ€§èƒ½ï¼Œç„¶åä¼˜åŒ–ä»£ç å•¦ï¼Œå¦‚æœæœ‰å°ä¼™ä¼´æƒ³ä¸€èµ·è®¨è®ºè®¨è®ºï¼Œæ¬¢è¿ã€‚</p>

</main>

    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      Open-Source | <a href="https://github.com/goodroot/hugo-classic">Github</a>
      
    </footer>
  </body>
</html>

